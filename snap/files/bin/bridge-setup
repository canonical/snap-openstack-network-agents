#!/usr/bin/env bash
set -euo pipefail
log(){ echo "bridge-setup: $*" >&2; }
die(){ echo "bridge-setup ERROR: $*" >&2; exit 1; }

apply_from_snap_config() {
  local iface bridge phys
  iface="$(snapctl get network.interface || true)"
  bridge="$(snapctl get network.bridge || true)"; : "${bridge:=br-ex}"
  phys="$(snapctl get network.physnet || true)"; : "${phys:=physnet1}"
  [[ -n "$iface" ]] || { log "no network.interface set; skipping"; exit 0; }
  ensure_bridge_and_mapping "${bridge}" "${iface}" "${phys}"
}

ensure_bridge_and_mapping() {
  local br="$1" ifc="$2" phys="$3"
  local ovsctl=""
  if [[ -x "${SNAP}/usr/bin/ovs-vsctl" ]]; then
    ovsctl="${SNAP}/usr/bin/ovs-vsctl"
  elif [[ -x /snap/microovn/current/usr/bin/ovs-vsctl ]]; then
    ovsctl="/snap/microovn/current/usr/bin/ovs-vsctl"
  fi
  [[ -n "$ovsctl" ]] || die "ovs-vsctl not found; stage openvswitch-switch into the snap"

  local dbopt=""
  if [[ -S /var/snap/microovn/common/run/switch//db.sock ]]; then
    dbopt="--db=unix:/var/snap/microovn/common/run/switch//db.sock"
  elif [[ -S /var/run/openvswitch/db.sock ]]; then
    dbopt="--db=unix:/var/run/openvswitch/db.sock"
  fi

  # Ovsctl wrapper that adds --db option if a socket is found
  ovs() { "$ovsctl" ${dbopt:+$dbopt} "$@"; }

  if [[ -n "$ovsctl" ]]; then
    ovs --may-exist add-br "$br"
    ovs --may-exist add-port "$br" "$ifc"
    ip link set dev "$br" up || true
    ip link set dev "$ifc" up || true
    local current
    current=$(ovs --if-exists get Open_vSwitch . external_ids:ovn-bridge-mappings 2>/dev/null | tr -d '"') || current=""
    if [[ "$current" == *"$phys:$br"* ]]; then
      log "mapping $phys:$br already present"
    else
      if [[ -n "$current" && "$current" != "[]" ]]; then
        ovs set Open_vSwitch . external_ids:ovn-bridge-mappings="${current},${phys}:${br}"
      else
        ovs set Open_vSwitch . external_ids:ovn-bridge-mappings="${phys}:${br}"
      fi
      log "set mapping ${phys}:${br}"
    fi

    local mac cur_mac_map updated_mac_map replaced
    mac="$(cat "/sys/class/net/${br}/address" 2>/dev/null || true)"
    if [[ -z "$mac" ]]; then
      mac="$(ip -o link show "$br" 2>/dev/null | awk -F'link/ether ' '{print $2}' | awk '{print $1}')"
    fi
    if [[ -n "$mac" && "$mac" != "00:00:00:00:00:00" ]]; then
      cur_mac_map=$(ovs --if-exists get Open_vSwitch . external_ids:ovn-chassis-mac-mappings 2>/dev/null | tr -d '"' || true)
      [[ "$cur_mac_map" == "[]" ]] && cur_mac_map=""

      if [[ -z "$cur_mac_map" ]]; then
        updated_mac_map="${phys}:${mac}"
      else
        IFS=',' read -r -a parts <<< "$cur_mac_map"
        updated_mac_map=""
        replaced=0
        for ent in "${parts[@]}"; do
          [[ -z "$ent" ]] && continue
          if [[ "$ent" == "$phys:"* ]]; then
            ent="${phys}:${mac}"
            replaced=1
          fi
          updated_mac_map="${updated_mac_map:+$updated_mac_map,}${ent}"
        done
        if [[ "$replaced" -eq 0 ]]; then
          updated_mac_map="${updated_mac_map:+$updated_mac_map,}${phys}:${mac}"
        fi
      fi
      ovs set Open_vSwitch . external_ids:ovn-chassis-mac-mappings="${updated_mac_map}"
      log "set chassis-mac mapping ${phys}:${mac}"
    else
      log "could not determine MAC for ${ifc}; skipping chassis-mac mapping"
    fi

    local gw cms newcms
    gw="$(snapctl get network.enable-chassis-as-gw || true)"
    if [[ "${gw,,}" == "true" ]]; then
      cms="$(ovs --if-exists get Open_vSwitch . external_ids:ovn-cms-options 2>/dev/null | tr -d '"' || true)"
      [[ "$cms" == "[]" ]] && cms=""
      if [[ "$cms" != *"enable-chassis-as-gw"* ]]; then
        newcms="${cms:+$cms,}enable-chassis-as-gw"
        ovs set Open_vSwitch . external_ids:ovn-cms-options="${newcms}"
        log "enabled gateway role (ovn-cms-options=${newcms})"
      else
        log "gateway role already enabled (ovn-cms-options=${cms})"
      fi
    fi

  else
    ip link show "$br" >/dev/null 2>&1 || ip link add "$br" type bridge
    ip link set "$ifc" down || true
    ip link set "$ifc" master "$br" || true
    ip link set "$br" up
    ip link set "$ifc" up
  fi
}

case "${1:-}" in
  apply-from-snap-config) apply_from_snap_config ;;
  ensure)                 ensure_bridge_and_mapping "${2:?br}" "${3:?iface}" "${4:?physnet}" ;;
  *) echo "Usage: bridge-setup apply-from-snap-config | ensure <br> <iface> <physnet>" >&2; exit 2 ;;
esac
